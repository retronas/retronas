#!/bin/bash

## RetroNAS autogenerated

FLUSH=""
OPTSTRING="f"

while getopts $OPTSTRING ARG
do
  case $ARG in
    f)
      FLUSH=1
      ;;
  esac
done

MYURL="http://$(ip -4 -br a | awk '!/127/{sub(/\/[0-9].+$/, ""); print $3}' | head -n1)/3ds"
umask 002

generate_qr () {
  # Build path
  mkdir -p "${QRDIR}" 2>/dev/null
  # Convert URLs to HTML safe encoding:
  CIAURL=$( echo "${MYURL}/cia/$RELDIR/${BASENAME}" | sed 's/\ /%20/g' )
  QRURL=$( echo "${MYURL}/qr/$RELDIR/${BARENAME}.png" | sed 's/\ /%20/g' )
  # Generate QR code
  echo "Generating QR for ${BARENAME} ..."
  qrencode -o "${QRDIR}/${BARENAME}.png" -s 10 -8 "${CIAURL}"
  # Generate HTML file
  echo "\
  <html>\
  <center>\
  <br><br>\
  "${CIAURL}"\
  <br><br>\
  <img src="${BARENAME}.png" border="0">\
  <br><br>" > "${QRDIR}/${BARENAME}".html
}

flush() {
  echo "Flushing QR codes"
  rm -f {{ retronas_path }}/3ds/qr/*
}

clean() {
  ## Clean QR codes
  echo "Cleaning out QR codes..."
  find "{{ retronas_path }}/3ds/qr/" -type f -iname '*.png' | while read QRFILE
  do
    BASENAME=$( basename "${QRFILE}" )
    BARENAME="${BASENAME%.*}"
    BASEDIR=$( dirname "${QRFILE}" )
    RELDIR=$( echo "${BASEDIR}" | sed 's#{{ retronas_path }}/3ds/qr##g' )
    CIADIR="{{ retronas_path }}/3ds/cia/${RELDIR}"
    test -f "${CIADIR}/${BARENAME}".cia || test -f "${CIADIR}/${BARENAME}".CIA || rm -vf "${BASEDIR}/${BARENAME}.png" "${BASEDIR}/${BARENAME}.html"
  done
}

[ ! -z $FLUSH ] && flush
clean
## Find CIA files to scan
echo "Scanning for new CIA files, generating QR codes..."
find "{{ retronas_path }}/3ds/cia/" -type f -iname '*.cia' | while read CIAFILE
do
  BASENAME=$( basename "${CIAFILE}" )
  BARENAME="${BASENAME%.*}"
  BASEDIR=$( dirname "${CIAFILE}" )
  RELDIR=$( echo "${BASEDIR}" | sed 's#{{ retronas_path }}/3ds/cia##g' )
  QRDIR="{{ retronas_path }}/3ds/qr/${RELDIR}"
  test -f "${QRDIR}/${BARENAME}".png || generate_qr
done

echo "All done"
read -s